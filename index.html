<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boot Repair Company Shoe Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            transition: background-image 0.5s ease-in-out;
        }
        body.login-active {
            background-image: url('https://images.unsplash.com/photo-1599355848074-b3d5b1205532?q=80&w=1974&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .counter-display { font-weight: 700; font-size: 4rem; line-height: 1; }
        .tally-btn { transition: all 0.1s ease-in-out; border: 1px solid #d1d5db; }
        .tally-btn:active { transform: scale(0.97); background-color: #f3f4f6; }
        #shiftHistory::-webkit-scrollbar, #summaryContent::-webkit-scrollbar, #changeNotesList::-webkit-scrollbar { width: 6px; }
        #shiftHistory::-webkit-scrollbar-track, #summaryContent::-webkit-scrollbar-track, #changeNotesList::-webkit-scrollbar-track { background: #f3f4f6; }
        #shiftHistory::-webkit-scrollbar-thumb, #summaryContent::-webkit-scrollbar-thumb, #changeNotesList::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        #shiftHistory::-webkit-scrollbar-thumb:hover, #summaryContent::-webkit-scrollbar-thumb:hover, #changeNotesList::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .screen { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
        .screen.hidden { opacity: 0; transform: scale(0.98); pointer-events: none; position: absolute; }
        
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #e5e7eb; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #4f46e5; cursor: pointer; margin-top: -8px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: #e5e7eb; border-radius: 5px; }
        input[type=range]::-moz-range-thumb { height: 24px; width: 24px; border-radius: 50%; background: #4f46e5; cursor: pointer; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    
        .tab-btn {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center p-4 sm:p-6">

    <!-- Login Screen -->
    <div id="loginScreen" class="screen w-full max-w-md mx-auto">
        <div class="bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-2xl text-center">
             <img src="https://i.imgur.com/d9UOaUu.png" alt="Boot Repair Company Logo" class="mx-auto h-24 w-auto mb-6" onerror="this.onerror=null;this.src='https://placehold.co/600x200/cccccc/ffffff?text=Logo';">
            <h1 class="text-3xl font-bold text-gray-900">Employee Login</h1>
            <p class="text-gray-600 mt-2 mb-8">Enter your details to start your shift.</p>
            <form id="loginForm" class="space-y-4">
                <input type="text" id="firstNameInput" placeholder="First Name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white/70" required>
                <input type="text" id="lastNameInput" placeholder="Last Name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white/70" required>
                <input type="text" id="employeeNumberInput" placeholder="Employee Number" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white/70" required>
                <select id="sectorSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white/70 text-gray-700" required>
                    <option value="" disabled selected>Select your sector...</option>
                    <option value="Quality Control">Quality Control</option>
                    <option value="Cleaning">Cleaning</option>
                    <option value="Workshop">Workshop</option>
                    <option value="Steaming">Steaming</option>
                </select>
                <div class="flex items-center justify-center space-x-3 pt-3">
                    <input id="clockedInCheckbox" name="clockedIn" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                    <label for="clockedInCheckbox" class="font-medium text-gray-700 cursor-pointer">I have clocked in</label>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl text-lg shadow-sm transition-all !mt-6">Start Tally</button>
            </form>
             <button id="changeNotesBtn" class="mt-6 text-sm text-gray-500 hover:text-indigo-600">View Change Notes</button>
        </div>
    </div>
    
    <!-- Change Notes Screen -->
    <div id="changeNotesScreen" class="screen hidden w-full max-w-2xl mx-auto">
        <div class="bg-white p-8 rounded-2xl shadow-xl">
            <header class="text-center mb-6">
                 <h2 class="text-3xl font-bold text-gray-900">Change Notes</h2>
                 <button id="backToLoginBtn" class="mt-2 text-indigo-600 hover:text-indigo-800 transition">← Back to Login</button>
            </header>
            <div id="changeNotesList" class="space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                <div class="border-b pb-4">
                    <p class="font-semibold text-gray-800">Added Task-Specific Badges</p>
                    <p class="text-sm text-gray-600">Added a "Badges" tab to the Achievements page. Users can now earn a badge for completing 500 of each specific task.</p>
                </div>
                 <div class="border-b pb-4">
                     <p class="font-semibold text-gray-800">Restructured Achievements Page</p>
                     <p class="text-sm text-gray-600">The Achievements page now has submenus for "Achievements" and "Badges" to better organize rewards.</p>
                 </div>
                 <div class="border-b pb-4">
                     <p class="font-semibold text-gray-800">Added Shift Deletion</p>
                     <p class="text-sm text-gray-600">Users can now delete logged shifts from the history via a confirmation pop-up.</p>
                 </div>
            </div>
        </div>
    </div>


    <!-- Splash Screen -->
    <div id="splashScreen" class="screen hidden text-center bg-white p-8 rounded-2xl shadow-xl">
        <h2 id="welcomeMessage" class="text-4xl font-bold text-gray-900"></h2>
        <p class="text-gray-600 mt-3 mb-6">Select the tasks you'll be tracking today.</p>
        <div class="space-y-4 text-left max-w-xs mx-auto grid grid-cols-1 sm:grid-cols-2 gap-x-6">
             <div class="flex items-center">
                <input id="showWipeOversCheckbox" type="checkbox" data-tally="wipeOvers" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showWipeOversCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Wipe Overs</label>
            </div>
             <div class="flex items-center">
                <input id="showGlueJobsCheckbox" type="checkbox" data-tally="glueJobs" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showGlueJobsCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Glue Jobs</label>
            </div>
            <div class="flex items-center">
                <input id="showResoleCheckbox" type="checkbox" data-tally="resole" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showResoleCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Resole</label>
            </div>
            <div class="flex items-center">
                <input id="showSecondStrideCheckbox" type="checkbox" data-tally="secondStride" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showSecondStrideCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Second Stride QC</label>
            </div>
            <div class="flex items-center">
                <input id="showVivoCheckbox" type="checkbox" data-tally="vivo" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showVivoCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Vivo QC</label>
            </div>
            <div class="flex items-center">
                <input id="showFairfaxCheckbox" type="checkbox" data-tally="fairfax" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showFairfaxCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Fairfax QC</label>
            </div>
            <div class="flex items-center">
                <input id="showDeepCleanCheckbox" type="checkbox" data-tally="deepClean" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showDeepCleanCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Deep Clean</label>
            </div>
             <div class="flex items-center">
                <input id="showSteamingCheckbox" type="checkbox" data-tally="steaming" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer tally-checkbox">
                <label for="showSteamingCheckbox" class="ml-3 font-medium text-gray-700 cursor-pointer">Steaming</label>
            </div>
        </div>
        <button id="continueToAppBtn" class="w-full max-w-xs mx-auto mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl text-lg shadow-sm transition-all">Continue</button>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" class="screen hidden w-full max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <img src="https://i.imgur.com/d9UOaUu.png" alt="Boot Repair Company Logo" class="w-full max-w-sm mx-auto rounded-lg shadow-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/600x200/cccccc/ffffff?text=Logo+Not+Found';">
            <div class="flex justify-center items-center gap-4">
                <h2 id="loggedInUserDisplay" class="text-2xl font-semibold text-gray-800"></h2>
                <button id="achievementsBtn" class="text-indigo-600 hover:text-indigo-800 transition">Achievements</button>
            </div>
            <p id="liveClock" class="text-md text-gray-500 mt-2 font-mono"></p>
        </header>
        <div class="w-full flex flex-col lg:flex-row gap-6">
            <main class="w-full lg:w-1/2 space-y-6">
                <!-- Target Section -->
                <section class="bg-white p-6 rounded-2xl shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold text-gray-700">Target:</h2>
                        <span id="targetValueDisplay" class="text-2xl font-bold text-indigo-600">80</span>
                    </div>
                    <input type="range" id="targetSlider" min="20" max="200" step="10" class="w-full">
                    <div class="text-center mt-4">
                        <h3 class="text-lg font-semibold text-gray-700">Remaining (Points):</h3>
                        <div class="flex items-center justify-center gap-4">
                             <span id="remainingCounter" class="text-4xl font-bold text-gray-800">40</span>
                             <span id="percentageDisplay" class="text-2xl font-semibold text-gray-500">(0%)</span>
                        </div>
                    </div>
                </section>
                <!-- Counters Grid -->
                <div id="tallyGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <section id="wipeOversShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Wipe Overs</h2>
                        <div id="wipeOversCounter" class="counter-display text-center text-indigo-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="wipeOvers" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="wipeOvers" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                    <section id="glueJobsShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Glue Jobs</h2>
                        <div id="glueJobsCounter" class="counter-display text-center text-teal-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="glueJobs" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="glueJobs" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                    <section id="resoleShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Resole</h2>
                        <div id="resoleCounter" class="counter-display text-center text-amber-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="resole" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="resole" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                    <section id="secondStrideShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Second Stride QC</h2>
                        <div id="secondStrideCounter" class="counter-display text-center text-cyan-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="secondStride" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="secondStride" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                    <section id="vivoShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Vivo QC</h2>
                        <div id="vivoCounter" class="counter-display text-center text-red-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="vivo" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="vivo" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                    <section id="fairfaxShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Fairfax QC</h2>
                        <div id="fairfaxCounter" class="counter-display text-center text-lime-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="fairfax" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="fairfax" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                     <section id="deepCleanShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Deep Clean</h2>
                        <div id="deepCleanCounter" class="counter-display text-center text-purple-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="deepClean" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="deepClean" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                    <section id="steamingShoesSection" class="bg-white p-6 rounded-2xl shadow-md hidden tally-section">
                        <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Steaming</h2>
                        <div id="steamingCounter" class="counter-display text-center text-sky-600 mb-5">0</div>
                        <div class="grid grid-cols-2 gap-4"><button data-tally="steaming" class="tally-btn subtract-btn text-2xl">-</button><button data-tally="steaming" class="tally-btn add-btn text-2xl">+</button></div>
                    </section>
                </div>
                 <section class="bg-white p-6 rounded-2xl shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Total Items Handled</h2>
                    <div id="totalCounter" class="counter-display text-center text-slate-800 mb-1">0</div>
                </section>
                 <!-- Shift Notes Section -->
                <section class="bg-white p-6 rounded-2xl shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">Shift Notes</h2>
                    <textarea id="shiftNotesInput" class="w-full h-24 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Add any notes about your shift..."></textarea>
                </section>
                <!-- Actions -->
                <section class="bg-white p-6 rounded-2xl shadow-md">
                     <button id="logShiftBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-xl text-lg shadow-sm transition-all disabled:bg-gray-400 disabled:cursor-not-allowed">Log Shift</button>
                     <button id="resetAllBtn" class="mt-4 w-full text-gray-500 hover:text-red-600 transition-colors text-sm font-medium">Reset All Counts</button>
                     <button id="exitBtn" class="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl text-md shadow-sm transition-all">Exit Session</button>
                </section>
            </main>
            <!-- History -->
            <aside class="w-full lg:w-1/2 bg-white p-6 rounded-2xl shadow-md flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-gray-700 flex-grow text-center">Shift History</h2>
                    <button id="changeUserBtn" class="text-xs text-indigo-600 hover:underline">Change User</button>
                </div>
                 <p class="text-xs text-center text-gray-400 mb-4">Your User ID: <span id="userIdDisplay" class="font-mono"></span></p>
                <div id="shiftHistory" class="flex-grow h-64 lg:h-auto overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center mt-4">No shifts logged yet.</p>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Achievements Screen -->
    <div id="achievementsScreen" class="screen hidden w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
             <h2 class="text-3xl font-bold text-gray-900">My Progress</h2>
             <button id="backToTallyBtn" class="mt-2 text-indigo-600 hover:text-indigo-800 transition">← Back to Tally</button>
        </header>
        <div id="achievementsNav" class="flex border-b mb-6">
            <button data-tab="achievementsContent" class="tab-btn active">Achievements</button>
            <button data-tab="badgesContent" class="tab-btn">Badges</button>
        </div>
        <div id="achievementsContent" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div id="perfectWeekBadge" class="bg-white p-6 rounded-2xl shadow-md text-center transition-all">
                    <div id="perfectWeekIconContainer" class="mx-auto h-24 w-24 rounded-full flex items-center justify-center"></div>
                    <h3 class="text-xl font-bold mt-4">The Perfect Week</h3>
                    <p id="perfectWeekDescription" class="text-gray-600 text-sm mt-1"></p>
                    <p id="perfectWeekStreak" class="text-indigo-600 font-semibold mt-2"></p>
                </div>
                <div id="perfectMonthBadge" class="bg-white p-6 rounded-2xl shadow-md text-center transition-all">
                    <div id="perfectMonthIconContainer" class="mx-auto h-24 w-24 rounded-full flex items-center justify-center"></div>
                    <h3 class="text-xl font-bold mt-4">The Perfect Month</h3>
                    <p id="perfectMonthDescription" class="text-gray-600 text-sm mt-1"></p>
                    <p id="perfectMonthProgress" class="text-indigo-600 font-semibold mt-2"></p>
                </div>
            </div>
        </div>
        <div id="badgesContent" class="tab-content hidden">
             <div id="badgesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <!-- Badges will be injected here -->
             </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-2xl shadow-xl flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Shift Summary</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="summaryContent" class="text-gray-700 space-y-4 max-h-[60vh] overflow-y-auto pr-4"></div>
        </div>
    </div>

    <!-- Confirmation Modals -->
    <div id="confirmModal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md p-8 rounded-2xl shadow-xl text-center transform scale-95">
            <h3 id="confirmModalTitle" class="text-xl font-bold text-gray-900 mb-2">Are you sure?</h3>
            <p id="confirmModalText" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelActionBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen'), splashScreen = document.getElementById('splashScreen'), appScreen = document.getElementById('appScreen'), achievementsScreen = document.getElementById('achievementsScreen'), changeNotesScreen = document.getElementById('changeNotesScreen');
        const loginForm = document.getElementById('loginForm'), firstNameInput = document.getElementById('firstNameInput');
        const welcomeMessage = document.getElementById('welcomeMessage'), changeUserBtn = document.getElementById('changeUserBtn'), bodyEl = document.querySelector('body');
        const tallyGrid = document.getElementById('tallyGrid');
        const continueToAppBtn = document.getElementById('continueToAppBtn');
        const totalCounterEl = document.getElementById('totalCounter'), logShiftBtn = document.getElementById('logShiftBtn'), resetAllBtn = document.getElementById('resetAllBtn'), exitBtn = document.getElementById('exitBtn');
        const shiftHistoryContainer = document.getElementById('shiftHistory'), userIdDisplay = document.getElementById('userIdDisplay'), liveClockEl = document.getElementById('liveClock');
        const targetSlider = document.getElementById('targetSlider'), targetValueDisplay = document.getElementById('targetValueDisplay'), remainingCounterEl = document.getElementById('remainingCounter'), percentageDisplay = document.getElementById('percentageDisplay');
        const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
        const summaryModal = document.getElementById('summaryModal'), closeModalBtn = document.getElementById('closeModalBtn'), summaryContent = document.getElementById('summaryContent');
        const confirmModal = document.getElementById('confirmModal'), confirmModalTitle = document.getElementById('confirmModalTitle'), confirmModalText = document.getElementById('confirmModalText'), cancelActionBtn = document.getElementById('cancelActionBtn'), confirmActionBtn = document.getElementById('confirmActionBtn');
        const shiftNotesInput = document.getElementById('shiftNotesInput');
        const achievementsBtn = document.getElementById('achievementsBtn'), backToTallyBtn = document.getElementById('backToTallyBtn'), achievementsNav = document.getElementById('achievementsNav'), badgesGrid = document.getElementById('badgesGrid');
        const perfectWeekBadge = document.getElementById('perfectWeekBadge'), perfectWeekIconContainer = document.getElementById('perfectWeekIconContainer'), perfectWeekDescription = document.getElementById('perfectWeekDescription'), perfectWeekStreak = document.getElementById('perfectWeekStreak');
        const perfectMonthBadge = document.getElementById('perfectMonthBadge'), perfectMonthIconContainer = document.getElementById('perfectMonthIconContainer'), perfectMonthDescription = document.getElementById('perfectMonthDescription'), perfectMonthProgress = document.getElementById('perfectMonthProgress');
        const changeNotesBtn = document.getElementById('changeNotesBtn'), backToLoginBtn = document.getElementById('backToLoginBtn');


        // --- State & Config ---
        let counts = { wipeOvers: 0, glueJobs: 0, resole: 0, secondStride: 0, vivo: 0, fairfax: 0, deepClean: 0, steaming: 0 };
        const tallyLabels = { wipeOvers: 'Wipe Overs', glueJobs: 'Glue Jobs', resole: 'Resole', secondStride: 'Second Stride QC', vivo: 'Vivo QC', fairfax: 'Fairfax QC', deepClean: 'Deep Clean', steaming: 'Steaming' };
        let target = 80;
        let db, auth, userId, clockInterval;
        let isAuthReady = false;
        let allShifts = [];
        let visibleTallies = [];
        let lifetimeTotals = {};
        let currentAction = null;
        let currentActionTarget = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'boot-tracker-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };

        // --- Gemini API Function ---
        async function callGemini(prompt, elementToUpdate) {
            if (elementToUpdate) elementToUpdate.innerHTML = '<span class="text-gray-500">Generating...</span>';
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0]?.content?.parts[0]?.text || "Sorry, couldn't generate a response.";
                if (elementToUpdate) elementToUpdate.innerHTML = text.replace(/\n/g, '<br>');
            } catch (error) {
                console.error("Gemini API Error:", error);
                if (elementToUpdate) elementToUpdate.innerHTML = '<span class="text-red-500">Error generating content. Please try again.</span>';
            }
        }

        // --- Firebase Initialization ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; isAuthReady = true;
                    if (userIdDisplay) userIdDisplay.textContent = userId;
                    listenForShifts();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) { console.error("Sign-in failed:", error); }
                }
            });
        } catch (e) { console.error("Firebase initialization failed:", e); }
        
        // --- Screen & Flow Management ---
        function showScreen(screenToShow) {
            [loginScreen, splashScreen, appScreen, achievementsScreen, changeNotesScreen].forEach(screen => screen.classList.toggle('hidden', screen !== screenToShow));
            bodyEl.classList.toggle('login-active', screenToShow === loginScreen || screenToShow === changeNotesScreen);
            bodyEl.classList.toggle('items-center', screenToShow !== appScreen);
            bodyEl.classList.toggle('items-start', screenToShow === appScreen || screenToShow === achievementsScreen);
        }

        function launchApp(firstName) {
            welcomeMessage.textContent = `Welcome, ${firstName}!`;
            document.querySelectorAll('.tally-checkbox').forEach(cb => {
                const savedState = localStorage.getItem(`tally-${cb.dataset.tally}`);
                cb.checked = savedState !== 'false';
            });
            showScreen(splashScreen);
        }

        function initializeAppScreen() {
            visibleTallies = [];
            document.querySelectorAll('.tally-checkbox').forEach(cb => {
                const tallyName = cb.dataset.tally;
                localStorage.setItem(`tally-${tallyName}`, cb.checked);
                document.getElementById(`${tallyName}ShoesSection`).classList.toggle('hidden', !cb.checked);
                if(cb.checked) visibleTallies.push(tallyName);
            });
            
            showScreen(appScreen);
            
            const userName = localStorage.getItem('shoeTrackerUser');
            if (userName) loggedInUserDisplay.textContent = `Tracker for: ${userName}`;

            const savedTarget = localStorage.getItem('shoeTrackerTarget');
            target = savedTarget ? parseInt(savedTarget, 10) : 80;
            targetSlider.value = target;
            
            checkAllStreaks();
            if (userId) userIdDisplay.textContent = userId;
            updateCounters();
            updateClock();
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(updateClock, 1000);
        }

        // --- Confirmation Modal Logic ---
        function showConfirmModal(action, target, title, text) {
            currentAction = action;
            currentActionTarget = target;
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            confirmModal.classList.remove('hidden');
        }

        confirmActionBtn.addEventListener('click', () => { if(currentAction) currentAction(currentActionTarget); confirmModal.classList.add('hidden'); });
        cancelActionBtn.addEventListener('click', () => { currentAction = null; currentActionTarget = null; confirmModal.classList.add('hidden'); });

        // --- Event Listeners ---
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const n = firstNameInput.value.trim(); if(n){localStorage.setItem('shoeTrackerUser', n); localStorage.removeItem('streakData'); localStorage.removeItem('monthData'); localStorage.removeItem('badgeTotals'); launchApp(n);} });
        continueToAppBtn.addEventListener('click', initializeAppScreen);
        changeNotesBtn.addEventListener('click', () => showScreen(changeNotesScreen));
        backToLoginBtn.addEventListener('click', () => showScreen(loginScreen));
        
        function handleExit() {
            localStorage.clear(); 
            Object.keys(counts).forEach(key => counts[key] = 0);
            target = 80;
            showScreen(loginScreen);
        }
        
        exitBtn.addEventListener('click', () => showConfirmModal(handleExit, null, 'Exit Session?', 'Are you sure? All current counts will be lost and you will be logged out.'));
        changeUserBtn.addEventListener('click', () => showConfirmModal(handleExit, null, 'Change User?', 'Are you sure? This will log you out and reset all current counts.'));
        
        tallyGrid.addEventListener('click', (e) => {
            if(e.target.matches('.add-btn')) {
                counts[e.target.dataset.tally]++;
            } else if (e.target.matches('.subtract-btn')) {
                if(counts[e.target.dataset.tally] > 0) counts[e.target.dataset.tally]--;
            }
            updateCounters();
        });

        achievementsBtn.addEventListener('click', () => { updateAchievementsPage(); showScreen(achievementsScreen); });
        backToTallyBtn.addEventListener('click', () => showScreen(appScreen));

        resetAllBtn.addEventListener('click', () => { 
            showConfirmModal(() => {
                Object.keys(counts).forEach(key => counts[key] = 0); 
                updateCounters();
            }, null, 'Reset All Counts?', 'This will reset all current tallies to zero. Are you sure?');
        });

        targetSlider.addEventListener('input', (e) => {
            target = parseInt(e.target.value, 10);
            localStorage.setItem('shoeTrackerTarget', target);
            updateCounters();
        });

        achievementsNav.addEventListener('click', (e) => {
            if(e.target.matches('.tab-btn')) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(e.target.dataset.tab).classList.remove('hidden');
            }
        });

        shiftHistoryContainer.addEventListener('click', (e) => {
            const summaryBtn = e.target.closest('.generate-summary-btn');
            const deleteBtn = e.target.closest('.delete-shift-btn');

            if (summaryBtn) {
                const shiftId = summaryBtn.dataset.id;
                const shift = allShifts.find(s => s.id === shiftId);
                if (shift) {
                    let prompt = `Generate a brief, professional summary for a work shift at a boot repair company. The employee's name is ${localStorage.getItem('shoeTrackerUser') || 'the employee'}.
                    - Shift Target: ${shift.target} - Date: ${shift.timestamp ? shift.timestamp.toDate().toLocaleDateString() : 'N/A'}`;
                    Object.keys(tallyLabels).forEach(key => { if(shift[key]) prompt += `\n- ${tallyLabels[key]}: ${shift[key]}`; });
                    prompt += `\n- Employee Notes: ${shift.notes || 'No notes provided.'}\nKeep it positive and concise. Format it nicely.`;
                    
                    summaryContent.innerHTML = '<p class="text-gray-500">Generating summary...</p>';
                    summaryModal.classList.remove('hidden');
                    callGemini(prompt, summaryContent);
                }
            } else if (deleteBtn) {
                const shiftId = deleteBtn.dataset.id;
                showConfirmModal(async () => {
                     if (!isAuthReady || !userId || !shiftId) return;
                     try {
                         await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/shifts`, shiftId));
                     } catch(error) { console.error("Error deleting shift:", error); }
                }, null, 'Delete Shift?', 'Are you sure you want to permanently delete this shift log?');
            }
        });
        
        closeModalBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        summaryModal.addEventListener('click', (e) => { if (e.target === summaryModal) { summaryModal.classList.add('hidden'); } });


        logShiftBtn.addEventListener('click', async () => {
            let totalPoints = (counts.wipeOvers * 0.25);
            visibleTallies.forEach(key => { if(key !== 'wipeOvers') totalPoints += counts[key]; });
            
            const totalItems = visibleTallies.reduce((sum, key) => sum + counts[key], 0);

            if (!isAuthReady || !userId) { console.error("Auth not ready."); return; }
            if (totalItems === 0) return;
            
            const notes = shiftNotesInput.value.trim();
            if(totalPoints >= target) {
                updateWeeklyStreak();
                updateMonthlyStreak();
            }

            // Update lifetime totals for badges
            Object.keys(counts).forEach(key => {
                if(counts[key] > 0) lifetimeTotals[key] = (lifetimeTotals[key] || 0) + counts[key];
            });
            localStorage.setItem('badgeTotals', JSON.stringify(lifetimeTotals));

            try {
                let dataToLog = { target, notes, timestamp: serverTimestamp() };
                visibleTallies.forEach(key => dataToLog[key] = counts[key]);

                const collectionPath = `artifacts/${appId}/users/${userId}/shifts`;
                await addDoc(collection(db, collectionPath), dataToLog);
                
                Object.keys(counts).forEach(key => counts[key] = 0); 
                shiftNotesInput.value = ''; 
                updateCounters();
            } catch (error) { console.error("Error logging shift:", error); }
        });

        // --- Core Functions ---
        function updateCounters() {
            targetValueDisplay.textContent = target;
            Object.keys(counts).forEach(key => {
                const counterEl = document.getElementById(`${key}Counter`);
                if(counterEl) counterEl.textContent = counts[key];
            });

            let totalItems = 0;
            let totalPoints = 0;
            
            visibleTallies.forEach(key => {
                totalItems += counts[key];
                if(key === 'wipeOvers'){ totalPoints += counts[key] * 0.25; } 
                else { totalPoints += counts[key]; }
            });

            totalCounterEl.textContent = totalItems;
            logShiftBtn.disabled = totalItems === 0;

            const remaining = target - totalPoints;
            let percentage = 0;
            if (target > 0) { percentage = Math.floor((totalPoints / target) * 100); }
            if (percentage > 100) percentage = 100;
            percentageDisplay.textContent = `(${percentage}%)`;

            if (remaining <= 0) {
                remainingCounterEl.textContent = "Target Reached!";
                remainingCounterEl.classList.add('text-green-600');
                percentageDisplay.classList.add('text-green-600');
            } else {
                remainingCounterEl.textContent = remaining.toFixed(2);
                remainingCounterEl.classList.remove('text-green-600');
                percentageDisplay.classList.remove('text-green-600');
            }
        }
        
        function updateClock() {
            liveClockEl.textContent = new Date().toLocaleString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // --- Achievement Logic ---
        function getStreakData() { return localStorage.getItem('streakData') ? JSON.parse(localStorage.getItem('streakData')) : { streak: 0, lastDate: null }; }
        function setStreakData(data) { localStorage.setItem('streakData', JSON.stringify(data)); }
        function getMonthData() { return localStorage.getItem('monthData') ? JSON.parse(localStorage.getItem('monthData')) : { days: 0, lastDate: null, month: null }; }
        function setMonthData(data) { localStorage.setItem('monthData', JSON.stringify(data)); }
        
        function checkAllStreaks() {
            const streakData = getStreakData();
            if (streakData.lastDate) {
                const lastDate = new Date(streakData.lastDate);
                const today = new Date();
                const lastDay = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
                const todayDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                if (Math.ceil((todayDay - lastDay) / (1000 * 60 * 60 * 24)) > 1) {
                    setStreakData({ streak: 0, lastDate: null });
                }
            }
            const monthData = getMonthData();
            if (monthData.month !== new Date().getMonth()) {
                setMonthData({ days: 0, lastDate: null, month: new Date().getMonth() });
            }
        }

        function updateWeeklyStreak() {
            const streakData = getStreakData();
            const todayStr = new Date().toDateString();
            if (streakData.lastDate !== todayStr) {
                streakData.streak++;
                streakData.lastDate = todayStr;
                if (streakData.streak >= 5) localStorage.setItem('perfectWeekEarned', 'true');
                setStreakData(streakData);
            }
        }

        function updateMonthlyStreak() {
            const monthData = getMonthData();
            const today = new Date();
            const todayStr = today.toDateString();
            const currentMonth = today.getMonth();

            if (monthData.month !== currentMonth) {
                 monthData.days = 0;
                 monthData.month = currentMonth;
                 localStorage.removeItem(`perfectMonthEarned_${currentMonth-1}`);
            }

            if (monthData.lastDate !== todayStr) {
                monthData.days++;
                monthData.lastDate = todayStr;
                if (monthData.days >= 20) localStorage.setItem(`perfectMonthEarned_${currentMonth}`, 'true');
                setMonthData(monthData);
            }
        }

        function updateAchievementsPage() {
            const unlockedIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.332l.09.008a6.997 6.997 0 013.91 3.91l.008.09V16a1 1 0 11-2 0V8.332a4.997 4.997 0 00-3.91-3.91L9 4.332V3a1 1 0 011-1zm6.95 5.95a1 1 0 00-1.414-1.414l-1.06 1.06a1 1 0 101.414 1.414l1.06-1.06zM3.05 7.95a1 1 0 010 1.414l-1.06 1.06a1 1 0 01-1.414-1.414l1.06-1.06zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.93 4.93a1 1 0 011.414 0l1.06 1.06a1 1 0 01-1.414 1.414l-1.06-1.06a1 1 0 010-1.414zM12.6 14.07a1 1 0 010 1.414l-1.06 1.06a1 1 0 01-1.414-1.414l1.06-1.06a1 1 0 011.414 0z" /></svg>`;
            const lockedIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`;
            
            const weekEarned = localStorage.getItem('perfectWeekEarned') === 'true';
            const streakData = getStreakData();
            perfectWeekBadge.classList.toggle('opacity-60', !weekEarned);
            perfectWeekIconContainer.innerHTML = weekEarned ? unlockedIcon : lockedIcon;
            perfectWeekIconContainer.classList.toggle('bg-yellow-500', weekEarned);
            perfectWeekDescription.textContent = weekEarned ? 'Congratulations! You met your target for 5 days in a row.' : 'Hit your daily target for 5 days in a row to unlock.';
            perfectWeekStreak.textContent = weekEarned ? 'Achievement Unlocked!' : `Current Streak: ${streakData.streak || 0} / 5 days`;

            const currentMonth = new Date().getMonth();
            const monthEarned = localStorage.getItem(`perfectMonthEarned_${currentMonth}`) === 'true';
            const monthData = getMonthData();
            const monthUnlockedIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`;
            
            perfectMonthBadge.classList.toggle('opacity-60', !monthEarned);
            perfectMonthIconContainer.innerHTML = monthEarned ? monthUnlockedIcon : lockedIcon;
            perfectMonthIconContainer.classList.toggle('bg-green-500', monthEarned);
            perfectMonthDescription.textContent = monthEarned ? `Congratulations on a perfect ${new Date().toLocaleString('default', { month: 'long' })}!` : 'Hit your daily target 20 times this month to unlock.';
            perfectMonthProgress.textContent = monthEarned ? 'Achievement Unlocked!' : `Monthly Progress: ${monthData.days || 0} / 20 days`;
            
            // Render Task Badges
            badgesGrid.innerHTML = '';
            const starIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
            Object.keys(tallyLabels).forEach(key => {
                const total = lifetimeTotals[key] || 0;
                const earned = total >= 500;
                const badgeEl = document.createElement('div');
                badgeEl.className = `bg-white p-4 rounded-xl shadow-md text-center transition-all ${earned ? '' : 'opacity-60'}`;
                badgeEl.innerHTML = `
                    <div class="mx-auto h-20 w-20 rounded-full flex items-center justify-center ${earned ? 'bg-blue-500' : 'bg-gray-200'}">
                        ${earned ? starIcon : lockedIcon}
                    </div>
                    <h3 class="text-lg font-bold mt-3">That's a lot of ${tallyLabels[key]}!</h3>
                    <p class="text-gray-600 text-xs mt-1">Complete 500 ${tallyLabels[key]} to unlock.</p>
                    <p class="text-blue-600 font-semibold mt-2">${earned ? 'Badge Unlocked!' : `Progress: ${total} / 500`}</p>
                `;
                badgesGrid.appendChild(badgeEl);
            });

        }

        // --- History Logic ---
        function listenForShifts() {
            if (!isAuthReady || !userId) return;
            const collectionPath = `artifacts/${appId}/users/${userId}/shifts`;
            const q = query(collection(db, collectionPath));
            onSnapshot(q, (snapshot) => {
                allShifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allShifts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                
                lifetimeTotals = {};
                Object.keys(tallyLabels).forEach(key => lifetimeTotals[key] = 0);
                allShifts.forEach(shift => {
                    Object.keys(tallyLabels).forEach(key => {
                        if(shift[key]) lifetimeTotals[key] += shift[key];
                    });
                });
                localStorage.setItem('badgeTotals', JSON.stringify(lifetimeTotals));
                
                renderHistory(allShifts);
            }, (error) => console.error("Error listening to shifts:", error));
        }
        
        function renderHistory(shifts) {
            shiftHistoryContainer.innerHTML = shifts.length === 0 ? '<p class="text-gray-500 text-center mt-4">No shifts logged yet.</p>' : '';
            if (shifts.length > 0) {
                 shifts.forEach(shift => {
                    const el = document.createElement('div');
                    el.className = 'bg-gray-100 p-3 rounded-lg mb-3 relative';
                    const date = shift.timestamp ? shift.timestamp.toDate().toLocaleString('en-US') : 'Just now';
                    const notesText = shift.notes ? `<p class="mt-2 text-xs text-gray-600 italic border-l-2 border-gray-300 pl-2">${shift.notes}</p>` : '';
                    let shiftDetails = '';
                    
                    Object.keys(tallyLabels).forEach(key => {
                        if(shift[key]) shiftDetails += `<span class="font-semibold ml-3">${tallyLabels[key]}:</span> ${shift[key]}`;
                    });

                    el.innerHTML = `
                        <button class="delete-shift-btn absolute top-2 right-2 text-red-400 hover:text-red-600 transition-colors p-1 rounded-full" data-id="${shift.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                        <div class="flex justify-between items-start text-sm mb-2 pr-6">
                            <div>
                                <span class="font-semibold">Target:</span> ${shift.target || 'N/A'}
                                ${shiftDetails}
                            </div>
                            <span class="text-xs text-gray-500 text-right shrink-0 ml-2">${date}</span>
                        </div>
                        ${notesText}
                        <button class="generate-summary-btn w-full text-sm bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1 px-3 rounded-md transition-all mt-2" data-id="${shift.id}">✨ Generate Shift Summary</button>
                    `;
                    shiftHistoryContainer.appendChild(el);
                });
            }
        }
        
        // --- Initial Load ---
        window.addEventListener('load', () => { 
            const totals = localStorage.getItem('badgeTotals');
            lifetimeTotals = totals ? JSON.parse(totals) : {};
            const user = localStorage.getItem('shoeTrackerUser'); 
            if(user) launchApp(user); 
            else showScreen(loginScreen); 
        });
    </script>
</body>
</html>
